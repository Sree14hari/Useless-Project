<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vada Perfection Analyzer üç©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #F0571C;
            --secondary: #4ECDC4;
            --dark: #292F36;
            --light: #F7FFF7;
            --gray: #E0E5EC;
            --card-bg: rgba(255, 255, 255, 0.9);
            --glass: rgba(255, 255, 255, 0.25);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            background-image:  
                radial-gradient(circle at 10% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(78, 205, 196, 0.1) 0%, transparent 20%);
        }
        .container { width: 100%; max-width: 900px; animation: fadeIn 0.8s ease-out; }
        header { text-align: center; margin-bottom: 2.5rem; position: relative; }
        h1 {
            font-weight: 700;
            font-size: 3rem;
            margin: 0;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .card {
            background: var(--card-bg);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--glass);
        }
        .intro-text { margin: 1rem 0 2rem; color: #666; font-size: 1.1rem; }
        .file-upload-wrapper { position: relative; margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto; }
        .file-upload-label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2.5rem; background-color: white; border-radius: 16px; border: 2px dashed #D1D5DB; cursor: pointer; transition: var(--transition); }
        .file-upload-label:hover { border-color: var(--primary); background-color: #F9FAFB; transform: translateY(-3px); }
        .file-upload-label i { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; }
        input[type="file"] { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        #fileName { display: block; margin-top: 1rem; font-size: 0.9rem; color: var(--primary-dark); font-weight: 500; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 1rem 2.5rem; border-radius: 12px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: var(--transition); border: none; text-decoration: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255, 107, 53, 0.3); }
        .btn-primary:disabled { background: #D1D5DB; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary), #3BB4AD); color: white; }
        .btn-secondary:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(78, 205, 196, 0.3); }
        .btn i { margin-right: 8px; }
        #result { margin-top: 2rem; animation: fadeIn 0.6s ease-out; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 107, 53, 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; margin: 1.5rem auto; }
        .loading-text { font-weight: 500; color: #4B5563; }
        .vpi-score { font-size: 4rem; font-weight: 800; }
        .score-description { font-size: 1.1rem; color: #4B5563; max-width: 500px; margin: 0 auto; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin: 3rem 0; }
        .result-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideUp 0.5s ease-out forwards; opacity: 0; }
        .result-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .result-card:nth-child(2) { animation-delay: 0.2s; }
        .result-img { width: 100%; height: auto; object-fit: cover; }
        .result-label { padding: 1.2rem; font-weight: 600; text-align: center; }
        .download-section { margin-top: 2rem; animation: fadeIn 0.8s ease-out; }
        /* --- NEW STYLES FOR CERTIFICATE --- */
        #certificate-section { display: none; margin-top: 2.5rem; padding-top: 2rem; border-top: 2px solid var(--gray); animation: slideUp 0.8s ease-out; }
        #certificate-section h3 { margin-bottom: 1rem; color: var(--primary-dark); }
        .certificate-form { display: flex; justify-content: center; align-items: center; gap: 1rem; }
        #certificateName { padding: 0.8rem; border: 2px solid var(--gray); border-radius: 8px; font-size: 1rem; transition: var(--transition); }
        #certificateName:focus { border-color: var(--primary); outline: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Vada Perfection Analyzer</h1>
            <p class="intro-text">How perfect is your vada? Let our ridiculously over-engineered AI be the judge.</p>
        </header>
        <main>
            <div class="card">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="file-upload-wrapper">
                        <label for="vada_image_input" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span class="file-upload-text">Choose a vada image</span>
                            <span class="file-upload-subtext">JPG, PNG up to 5MB</span>
                            <span id="fileName"></span>
                        </label>
                        <input type="file" id="vada_image_input" name="vada_image" accept="image/*" required />
                    </div>
                    <button type="submit" id="submitBtn" class="btn btn-primary">
                        <i class="fas fa-search"></i> Analyze My Vada
                    </button>
                </form>
                <div id="result"></div>
            </div>
        </main>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('vada_image_input');
        const fileNameSpan = document.getElementById('fileName');
        const resultDiv = document.getElementById('result');
        const submitBtn = document.getElementById('submitBtn');

        fileInput.addEventListener('change', () => {
            fileNameSpan.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : '';
        });

        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            resultDiv.innerHTML = `<div class="loading"><div class="spinner"></div><p class="loading-text">Our AI is meticulously inspecting your vada...</p></div>`;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing';

            try {
                const res = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    const score = data.vpi_score;
                    let scoreColor, scoreText;
                    if (score >= 85) { scoreColor = 'linear-gradient(135deg, #10B981, #059669)'; scoreText = 'Exceptional! A culinary masterpiece!'; }
                    else if (score >= 70) { scoreColor = 'linear-gradient(135deg, #3B82F6, #2563EB)'; scoreText = 'Great job! A high-quality vada.'; }
                    else if (score >= 50) { scoreColor = 'linear-gradient(135deg, #F59E0B, #D97706)'; scoreText = 'A good effort, but room for improvement.'; }
                    else { scoreColor = 'linear-gradient(135deg, #EF4444, #DC2626)'; scoreText = 'Needs work. Please reconsider your technique.'; }

                    let certificateHTML = '';
                    // --- NEW: Check score to show certificate section ---
                    if (score >= 80) {
                        certificateHTML = `
                            <div id="certificate-section">
                                <h3>üèÜ Congratulations! Your Vada is Certified!</h3>
                                <p>Enter your name to generate a downloadable certificate.</p>
                                <div class="certificate-form mt-2">
                                    <input type="text" id="certificateName" placeholder="Enter Your Name">
                                    <button id="generateCertBtn" class="btn btn-primary">Generate</button>
                                </div>
                            </div>
                        `;
                    }

                    resultDiv.innerHTML = `
                        <h3 class="vpi-score" style="background: ${scoreColor}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ${score.toFixed(0)}<span style="font-size: 1.5rem; color: #6B7280;">/100</span>
                        </h3>
                        <p class="score-description">${scoreText}</p>
                        <div class="results-grid">
                            <div class="result-card"><img src="${data.annotated_image_url}?t=${new Date().getTime()}" alt="Annotated Vada" class="result-img"><div class="result-label">Visual Analysis</div></div>
                            <div class="result-card"><img src="${data.report_image_url}?t=${new Date().getTime()}" alt="Vada Report" class="result-img"><div class="result-label">Detailed Report</div></div>
                        </div>
                        <div class="download-section text-center">
                            <a href="${data.report_image_url}" class="btn btn-secondary" download="vada_report.png"><i class="fas fa-download"></i> Download Report</a>
                        </div>
                        ${certificateHTML} 
                    `;

                    // --- NEW: Add event listener for the certificate button if it exists ---
                    const certBtn = document.getElementById('generateCertBtn');
                    if (certBtn) {
                        certBtn.addEventListener('click', () => {
                            const name = document.getElementById('certificateName').value;
                            if (!name) {
                                alert('Please enter your name for the certificate.');
                                return;
                            }
                            // Trigger download by navigating to the certificate generation URL
                            window.location.href = `/generate_certificate?name=${encodeURIComponent(name)}&score=${score.toFixed(2)}`;
                        });
                    }

                } else {
                    resultDiv.innerHTML = `<div class="text-center" style="color: #EF4444;"><i class="fas fa-exclamation-triangle"></i><h3>Analysis Failed</h3><p>${data.error}</p></div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="text-center" style="color: #EF4444;"><i class="fas fa-exclamation-circle"></i><h3>Server Error</h3><p>Could not connect to backend.</p></div>`;
                console.error('Error:', err);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-search"></i> Analyze My Vada';
            }
        });
    </script>
</body>
</html>